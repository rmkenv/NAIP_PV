<!-- Map-based NAIP and MD imagery inference UI with hybrid basemap, augment+sharpen options, and detection table -->

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
  #map { height: 520px; margin: 10px 0; }
  .controls { display: flex; gap: 10px; flex-wrap: wrap; margin: 8px 0; align-items: center; }
  .controls label { font-size: 14px; }
  .hint { color:#444; font-size: 13px; margin-top: 4px; }
  .row { display:flex; gap: 14px; align-items: center; flex-wrap: wrap; }
  #result_panel { display: grid; grid-template-columns: 360px 1fr; gap: 10px; align-items: start; }
  #result_panel > div { overflow: auto; }
  #result_panel > div:not(:first-child) { height: 520px; }
  #result_panel > div:first-child img { max-width: 100%; border: 1px solid #ddd; border-radius: 6px; display: none; }
  #result_panel #result_map { height: 100%; width: 100%; display: none; }
  .badge { display:inline-block; padding:2px 6px; border-radius:10px; background:#eef; color:#334; font-size:12px; margin-left:6px; }
  #detections_table_container { margin: 8px 0 0 0; max-height: 200px; overflow-y: auto; }
  #detections_table { border-collapse: collapse; width: 100%; font-size: 13px; }
  #detections_table th, #detections_table td {
    border: 1px solid #ccc;
    padding: 4px 8px;
    text-align: center;
  }
  #detections_table th {
    background-color: #f0f0f0;
  }
</style>

<div>
  <h3>Draw a box anywhere in the U.S. to fetch imagery and detect solar panels</h3>
  <div id="map"></div>

  <div class="controls">
    <div class="row">
      <label>Basemap:
        <select id="basemap">
          <option value="hybrid" selected>ESRI World Imagery Hybrid</option>
          <option value="osm">OpenStreetMap</option>
        </select>
      </label>
      <label>Source:
        <select id="use_source">
          <option value="naip" selected>NAIP</option>
          <option value="md">Maryland 6-inch</option>
          <option value="usda">USDA</option>
        </select>
      </label>
      <label>Export width_px:
        <input id="width_px" type="number" value="2048" min="512" max="3500" />
      </label>
      <label>imgsz:
        <input id="imgsz" type="number" value="1536" min="640" max="2048" step="32" />
      </label>
      <label>conf:
        <input id="conf" type="number" value="0.15" min="0" max="1" step="0.01" />
      </label>
      <label>iou:
        <input id="iou" type="number" value="0.45" min="0" max="1" step="0.05" />
      </label>
      <label><input id="augment" type="checkbox" /> Augment (TTA)</label>
      <label><input id="sharpen" type="checkbox" /> Sharpen</label>
      <button id="preset_high_recall" type="button">High Recall</button>
      <button id="run_btn" disabled>Run Detection</button>
    </div>
    <div class="hint">
      Hint: Draw areas ~0.5 to 100 km² to maintain detail. <span class="badge">Tiling enabled</span>
    </div>
  </div>

  <div id="status" class="hint"></div>

  <div id="result_panel">
    <div>
      <img id="result_img" alt="Detection result" />
    </div>
    <div>
      <div id="result_map"></div>
      <div id="detections_table_container" style="display:none;">
        <h4>Detections</h4>
        <table id="detections_table" border="1">
          <thead>
            <tr><th>#</th><th>Confidence</th><th>Latitude</th><th>Longitude</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
  // Initialize map and layers
  const usaCenter = [39.5, -98.35];
  const map = L.map('map', { zoomControl: true }).setView(usaCenter,4);

  const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri & contributors'
  });

  const esriLabels = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Labels/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Labels &copy; Esri'
  });

  const hybrid = L.layerGroup([esriImagery, esriLabels]);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 19
  });

  hybrid.addTo(map);

  document.getElementById('basemap').addEventListener('change', e => {
    const val = e.target.value;
    map.eachLayer(layer => map.removeLayer(layer))
    if(val === 'osm'){
      osm.addTo(map);
    }else{
      hybrid.addTo(map);
    }
  });

  // Drawing tools setup
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    draw: {
      rectangle: {shapeOptions: {color: '#f97316', weight: 2}},
      polygon:false, polyline:false, circle:false, marker:false, circlemarker:false
    },
    edit: {featureGroup: drawnItems, edit:true, remove:true}
  });
  map.addControl(drawControl);

  // Area Constraints
  function bboxAreaKm2(bounds){
    const toRad = d => d*Math.PI/180;
    const lat1 = bounds.getSouth(), lat2 = bounds.getNorth(),
          lon1 = bounds.getWest(), lon2 = bounds.getEast();
    const latMid = toRad((lat1+lat2)/2);
    const mPerDegLat = 111132.92 - 559.82 * Math.cos(2*latMid) + 1.175*Math.cos(4*latMid) -0.0023*Math.cos(6*latMid);
    const mPerDegLon = 111412.84 * Math.cos(latMid) - 93.5 * Math.cos(3*latMid) + 0.118 * Math.cos(5*latMid);
    const width = Math.abs(lon2-lon1) * mPerDegLon;
    const height = Math.abs(lat2 - lat1) * mPerDegLat;
    return (width*height)/1e6;
  }

  function validateRect(layer){
    const area = bboxAreaKm2(layer.getBounds());
    if(area < 0.5 || area > 100){
      alert('Selected area is '+area.toFixed(2)+' km². Please select between 0.5 and 100 km².');
      return false;
    }
    return true;
  }

  let lastRect = null;

  map.on('draw:created', e=>{
    if(!validateRect(e.layer))return;
    drawnItems.clearLayers();
    lastRect = e.layer;
    drawnItems.addLayer(lastRect);
    document.getElementById('run_btn').disabled = false;
  });

  map.on('draw:edited', e=>{
    const layers = drawnItems.getLayers();
    if(layers.length && validateRect(layers[0]))
      lastRect = layers[0];
  });

  map.on('draw:deleted', e=>{
    lastRect = null;
    document.getElementById('run_btn').disabled = true;
  });

  // Post detection request
  async function postInfer(bounds, params){
    const fd = new FormData();
    fd.append('min_lon', bounds.getWest());
    fd.append('min_lat', bounds.getSouth());
    fd.append('max_lon', bounds.getEast());
    fd.append('max_lat', bounds.getNorth());
    fd.append('width_px', params.width_px);
    fd.append('use_source', params.use_source);
    fd.append('conf', params.conf);
    fd.append('iou', params.iou);
    fd.append('imgsz', params.imgsz);
    fd.append('augment', params.augment);
    fd.append('sharpen', params.sharpen);

    const resp = await fetch('/infer_imagery', {method:'POST',body:fd});
    if(!resp.ok)
      throw new Error(await resp.text());
    return await resp.json();
  }

  // Show detected overlays
  function showDetectionMap(data, bounds){
    const resultMapDiv = document.getElementById('result_map');
    resultMapDiv.style.display = 'block';

    if(window.resultMap)
      window.resultMap.remove();

    window.resultMap = L.map('result_map', {zoomControl:true, attributionControl:false});

    const imageBounds = L.latLngBounds(bounds.getSouthWest(), bounds.getNorthEast());

    const imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri & contributors'
    });

    const labels = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Labels/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Labels &copy; Esri'
    });

    L.layerGroup([imagery, labels]).addTo(window.resultMap);

    L.imageOverlay(data.image_data_url, imageBounds).addTo(window.resultMap);

    window.resultMap.fitBounds(imageBounds);
  }

  // Populate detections table
  function populateDetectionsTable(detections){
    const container = document.getElementById('detections_table_container');
    const tbody = document.querySelector('#detections_table tbody');
    tbody.innerHTML = '';
    if(!detections || detections.length === 0) {
      container.style.display = 'none';
      return;
    }
    container.style.display = 'block';
    detections.forEach((det,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${(det.score*100).toFixed(1)}%</td>
        <td>${det.lat.toFixed(6)}</td>
        <td>${det.lon.toFixed(6)}</td>
      `.trim();
      tbody.appendChild(tr);
    });
  }

  // Preset controls for high recall
  document.getElementById('preset_high_recall').addEventListener('click', ()=>{
    document.getElementById('width_px').value = 2048;
    document.getElementById('imgsz').value = 1536;
    document.getElementById('conf').value = 0.15;
    document.getElementById('iou').value = 0.45;
    document.getElementById('augment').checked = true;
    document.getElementById('sharpen').checked = true;
  });

  // Run detection button
  document.getElementById('run_btn').addEventListener('click', async ()=>{
    const status = document.getElementById('status');
    const imgEl = document.getElementById('result_img');
    const mapEl = document.getElementById('result_map');

    if(!lastRect) return;

    const bounds = lastRect.getBounds();
    const params = {
      width_px: Number(document.getElementById('width_px').value),
      use_source: document.getElementById('use_source').value,
      conf: Number(document.getElementById('conf').value),
      iou: Number(document.getElementById('iou').value),
      imgsz: Number(document.getElementById('imgsz').value),
      augment: document.getElementById('augment').checked,
      sharpen: document.getElementById('sharpen').checked,
    };

    status.textContent = 'Fetching imagery and running detection...';
    imgEl.style.display = 'none';
    mapEl.style.display = 'none';
    mapEl.innerHTML = '';
    populateDetectionsTable([]);

    try {
      const data = await postInfer(bounds, params);
      if(data.error) throw new Error(data.error);

      imgEl.src = data.image_data_url;
      imgEl.style.display = 'block';

      showDetectionMap(data, lastRect.getBounds());

      status.textContent = `Detected ${data.count} panels | Area: approx. ${(data.total_area || 'N/A')} | `+
                           `Resolution: ${data.mpp_x?.toFixed(3)}m x ${data.mpp_y?.toFixed(3)}m | `+
                           `Augment: ${params.augment} | Sharpen: ${params.sharpen} | Source: ${data.imagery_source}`;

      populateDetectionsTable(data.detections);

    } catch(e){
      status.textContent = 'Error: ' + e.message;
      console.error(e);
    }
  });
</script>
