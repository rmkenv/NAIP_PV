<!-- Map-based NAIP fetch and inference -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
  #map { height: 420px; margin: 10px 0; }
  .controls { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
  .controls label { font-size: 14px; }
</style>

<div>
  <h3>Map: Draw a box to fetch NAIP and detect</h3>
  <div id="map"></div>

  <div class="controls">
    <label>Source:
      <select id="use_usgs">
        <option value="true" selected>USGS</option>
        <option value="false">USDA</option>
      </select>
    </label>
    <label>Export width_px:
      <input id="width_px" type="number" value="2048" min="512" max="3500" />
    </label>
    <label>imgsz:
      <input id="imgsz" type="number" value="1280" min="640" max="2048" step="32" />
    </label>
    <label>conf:
      <input id="conf" type="number" value="0.2" min="0" max="1" step="0.01" />
    </label>
    <label>iou (NMS):
      <input id="iou" type="number" value="0.4" min="0" max="1" step="0.05" />
    </label>
    <button id="run_btn" disabled>Run detection on drawn box</button>
  </div>

  <div id="status" style="margin:6px 0; color:#555;"></div>
  <img id="result_img" alt="Result" style="max-width:100%; display:none;" />
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
  // Initialize map
  const map = L.map('map').setView([29.76, -95.37], 10); // Houston area default
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  // Draw controls (rectangle only)
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);
  const drawControl = new L.Control.Draw({
    draw: {
      polygon: false, polyline: false, circle: false, marker: false, circlemarker: false,
      rectangle: { showArea: true, shapeOptions: { color: '#f97316', weight: 2 } }
    },
    edit: { featureGroup: drawnItems, edit: true, remove: true }
  });
  map.addControl(drawControl);

  let lastRect = null;
  map.on(L.Draw.Event.CREATED, function (e) {
    drawnItems.clearLayers();
    lastRect = e.layer;
    drawnItems.addLayer(lastRect);
    document.getElementById('run_btn').disabled = false;
  });

  map.on(L.Draw.Event.EDITED, function () {
    // Keep using the single edited rectangle
    const layers = drawnItems.getLayers();
    lastRect = layers.length ? layers[0] : null;
  });

  map.on(L.Draw.Event.DELETED, function () {
    lastRect = null;
    document.getElementById('run_btn').disabled = true;
  });

  async function postInferNAIP(bounds, params) {
    const fd = new FormData();
    // Bounds are WGS84 from Leaflet
    fd.append('min_lon', bounds.getWest());
    fd.append('min_lat', bounds.getSouth());
    fd.append('max_lon', bounds.getEast());
    fd.append('max_lat', bounds.getNorth());
    fd.append('width_px', params.width_px);
    fd.append('use_usgs', params.use_usgs);
    fd.append('conf', params.conf);
    fd.append('iou', params.iou);
    fd.append('imgsz', params.imgsz);
    const res = await fetch('/infer_naip', { method: 'POST', body: fd });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(txt || ('HTTP ' + res.status));
    }
    return res.json();
  }

  document.getElementById('run_btn').addEventListener('click', async () => {
    const status = document.getElementById('status');
    const imgEl = document.getElementById('result_img');
    if (!lastRect) return;

    const bounds = lastRect.getBounds();
    const params = {
      use_usgs: document.getElementById('use_usgs').value === 'true',
      width_px: Number(document.getElementById('width_px').value),
      imgsz: Number(document.getElementById('imgsz').value),
      conf: Number(document.getElementById('conf').value),
      iou: Number(document.getElementById('iou').value),
    };

    status.textContent = 'Fetching NAIP and running detection...';
    imgEl.style.display = 'none';

    try {
      const data = await postInferNAIP(bounds, params);
      if (data.error) throw new Error(data.error);
      imgEl.src = data.image_data_url;
      imgEl.style.display = 'block';
      status.textContent = `Detections: ${data.count} | Total area (px): ${Math.round(data.total_area_pixels)} | mpp_x: ${data.mpp_x?.toFixed?.(3)} m | mpp_y: ${data.mpp_y?.toFixed?.(3)} m`;
    } catch (err) {
      console.error(err);
      status.textContent = 'Error: ' + (err.message || err);
    }
  });
</script>
